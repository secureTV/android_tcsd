
/*
 * Licensed Materials - Property of IBM
 *
 * trousers - An open source TCG Software Stack
 *
 * (C) Copyright International Business Machines Corp. 2004-2006
 *
 */


#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <sys/mman.h>
#include <fcntl.h>
#include <errno.h>

#include "trousers/tss.h"
#include "trousers_types.h"
#include "trousers_types.h"
#include "tcs_tsp.h"
#include "tcs_utils.h"
#include "tcs_int_literals.h"
#include "tcsps.h"
#include "tcslog.h"
#include "tcsd_wrap.h"
#include "tcsd.h"
#include "tcs_aik.h"


// CA root credential		0x0002xxxx
#define TSSI_CREDENTIAL_INDEX_PrivacyCACert		((UINT32)0x00020001)
#define TSSI_CREDENTIAL_INDEX_EUCACert			((UINT32)0x00020002)
#define TSSI_CREDENTIAL_INDEX_SoftCACert		((UINT32)0x00020003)

BYTE euCAcert[]={
0x2D,0x2D,0x2D,0x2D,0x2D,0x42,0x45,0x47,0x49,0x4E,0x20,0x43,0x45,0x52,0x54,0x49,
0x46,0x49,0x43,0x41,0x54,0x45,0x2D,0x2D,0x2D,0x2D,0x2D,0x0A,0x4D,0x49,0x49,0x45,
0x46,0x54,0x43,0x43,0x41,0x76,0x32,0x67,0x41,0x77,0x49,0x42,0x41,0x67,0x49,0x4A,
0x41,0x49,0x6C,0x51,0x46,0x6F,0x2B,0x48,0x71,0x35,0x30,0x76,0x4D,0x41,0x30,0x47,
0x43,0x53,0x71,0x47,0x53,0x49,0x62,0x33,0x44,0x51,0x45,0x42,0x42,0x51,0x55,0x41,
0x4D,0x47,0x51,0x78,0x43,0x7A,0x41,0x4A,0x42,0x67,0x4E,0x56,0x0A,0x42,0x41,0x59,
0x54,0x41,0x6D,0x4E,0x75,0x4D,0x52,0x45,0x77,0x44,0x77,0x59,0x44,0x56,0x51,0x51,
0x49,0x45,0x77,0x68,0x7A,0x61,0x47,0x56,0x75,0x65,0x6D,0x68,0x6C,0x62,0x6A,0x45,
0x52,0x4D,0x41,0x38,0x47,0x41,0x31,0x55,0x45,0x42,0x78,0x4D,0x49,0x63,0x32,0x68,
0x6C,0x62,0x6E,0x70,0x6F,0x5A,0x57,0x34,0x78,0x44,0x7A,0x41,0x4E,0x0A,0x42,0x67,
0x4E,0x56,0x42,0x41,0x6F,0x54,0x42,0x6D,0x35,0x6C,0x62,0x47,0x52,0x30,0x64,0x6A,
0x45,0x50,0x4D,0x41,0x30,0x47,0x41,0x31,0x55,0x45,0x43,0x78,0x4D,0x47,0x62,0x6D,
0x56,0x73,0x5A,0x48,0x52,0x32,0x4D,0x51,0x30,0x77,0x43,0x77,0x59,0x44,0x56,0x51,
0x51,0x44,0x45,0x77,0x52,0x6C,0x64,0x57,0x4E,0x68,0x4D,0x42,0x34,0x58,0x0A,0x44,
0x54,0x45,0x30,0x4D,0x44,0x49,0x78,0x4D,0x6A,0x41,0x79,0x4D,0x6A,0x59,0x77,0x4D,
0x31,0x6F,0x58,0x44,0x54,0x49,0x30,0x4D,0x44,0x49,0x78,0x4D,0x44,0x41,0x79,0x4D,
0x6A,0x59,0x77,0x4D,0x31,0x6F,0x77,0x5A,0x44,0x45,0x4C,0x4D,0x41,0x6B,0x47,0x41,
0x31,0x55,0x45,0x42,0x68,0x4D,0x43,0x59,0x32,0x34,0x78,0x45,0x54,0x41,0x50,0x0A,
0x42,0x67,0x4E,0x56,0x42,0x41,0x67,0x54,0x43,0x48,0x4E,0x6F,0x5A,0x57,0x35,0x36,
0x61,0x47,0x56,0x75,0x4D,0x52,0x45,0x77,0x44,0x77,0x59,0x44,0x56,0x51,0x51,0x48,
0x45,0x77,0x68,0x7A,0x61,0x47,0x56,0x75,0x65,0x6D,0x68,0x6C,0x62,0x6A,0x45,0x50,
0x4D,0x41,0x30,0x47,0x41,0x31,0x55,0x45,0x43,0x68,0x4D,0x47,0x62,0x6D,0x56,0x73,
0x0A,0x5A,0x48,0x52,0x32,0x4D,0x51,0x38,0x77,0x44,0x51,0x59,0x44,0x56,0x51,0x51,
0x4C,0x45,0x77,0x5A,0x75,0x5A,0x57,0x78,0x6B,0x64,0x48,0x59,0x78,0x44,0x54,0x41,
0x4C,0x42,0x67,0x4E,0x56,0x42,0x41,0x4D,0x54,0x42,0x47,0x56,0x31,0x59,0x32,0x45,
0x77,0x67,0x67,0x45,0x69,0x4D,0x41,0x30,0x47,0x43,0x53,0x71,0x47,0x53,0x49,0x62,
0x33,0x0A,0x44,0x51,0x45,0x42,0x41,0x51,0x55,0x41,0x41,0x34,0x49,0x42,0x44,0x77,
0x41,0x77,0x67,0x67,0x45,0x4B,0x41,0x6F,0x49,0x42,0x41,0x51,0x43,0x7A,0x77,0x38,
0x39,0x47,0x6B,0x75,0x52,0x62,0x53,0x4D,0x4B,0x35,0x6A,0x4E,0x72,0x36,0x38,0x58,
0x46,0x61,0x53,0x32,0x33,0x50,0x4D,0x50,0x6C,0x62,0x76,0x44,0x7A,0x51,0x62,0x30,
0x67,0x77,0x0A,0x79,0x6F,0x5A,0x42,0x50,0x6D,0x4F,0x6B,0x6D,0x75,0x61,0x76,0x37,
0x56,0x31,0x33,0x39,0x64,0x48,0x4A,0x36,0x55,0x52,0x75,0x77,0x45,0x79,0x5A,0x66,
0x5A,0x42,0x41,0x6D,0x7A,0x35,0x56,0x38,0x68,0x77,0x6E,0x4A,0x59,0x31,0x44,0x46,
0x6D,0x71,0x42,0x6B,0x30,0x56,0x2F,0x69,0x34,0x55,0x42,0x72,0x68,0x69,0x47,0x42,
0x6B,0x63,0x75,0x0A,0x47,0x35,0x4D,0x66,0x36,0x51,0x35,0x4E,0x32,0x2B,0x4A,0x6F,
0x64,0x37,0x78,0x68,0x6F,0x46,0x59,0x73,0x30,0x50,0x41,0x6A,0x35,0x62,0x77,0x6F,
0x56,0x51,0x37,0x2B,0x45,0x67,0x30,0x6D,0x45,0x6E,0x65,0x69,0x5A,0x6F,0x45,0x32,
0x62,0x49,0x63,0x74,0x4A,0x78,0x45,0x76,0x44,0x54,0x46,0x46,0x33,0x6F,0x6C,0x63,
0x6C,0x66,0x7A,0x61,0x0A,0x47,0x44,0x31,0x42,0x4C,0x51,0x44,0x49,0x6B,0x31,0x6B,
0x77,0x59,0x71,0x63,0x78,0x77,0x32,0x73,0x63,0x66,0x7A,0x75,0x30,0x6A,0x54,0x50,
0x33,0x45,0x37,0x7A,0x42,0x7A,0x31,0x64,0x66,0x32,0x6B,0x71,0x7A,0x75,0x59,0x6D,
0x4A,0x56,0x57,0x4E,0x51,0x66,0x44,0x75,0x66,0x72,0x6A,0x46,0x31,0x7A,0x48,0x6C,
0x71,0x6F,0x5A,0x76,0x37,0x0A,0x55,0x4C,0x32,0x64,0x78,0x51,0x34,0x70,0x2B,0x72,
0x71,0x6B,0x46,0x41,0x6D,0x38,0x6D,0x53,0x35,0x71,0x46,0x61,0x7A,0x4E,0x6B,0x43,
0x4F,0x41,0x57,0x5A,0x64,0x77,0x2F,0x45,0x65,0x58,0x6E,0x37,0x2F,0x4B,0x71,0x2B,
0x47,0x68,0x6D,0x62,0x33,0x34,0x33,0x56,0x77,0x5A,0x75,0x6E,0x75,0x49,0x67,0x44,
0x4F,0x68,0x41,0x6D,0x51,0x62,0x0A,0x70,0x43,0x59,0x36,0x7A,0x71,0x7A,0x57,0x7A,
0x73,0x63,0x62,0x32,0x30,0x4C,0x45,0x4A,0x63,0x6E,0x36,0x36,0x47,0x4A,0x71,0x35,
0x59,0x4E,0x52,0x7A,0x32,0x62,0x78,0x63,0x2F,0x56,0x62,0x67,0x71,0x7A,0x5A,0x38,
0x74,0x50,0x4F,0x45,0x56,0x73,0x4A,0x41,0x67,0x4D,0x42,0x41,0x41,0x47,0x6A,0x67,
0x63,0x6B,0x77,0x67,0x63,0x59,0x77,0x0A,0x48,0x51,0x59,0x44,0x56,0x52,0x30,0x4F,
0x42,0x42,0x59,0x45,0x46,0x4D,0x2F,0x55,0x5A,0x57,0x54,0x5A,0x70,0x4D,0x75,0x6B,
0x6D,0x35,0x72,0x73,0x32,0x41,0x34,0x47,0x37,0x42,0x75,0x70,0x67,0x39,0x4F,0x4F,
0x4D,0x49,0x47,0x57,0x42,0x67,0x4E,0x56,0x48,0x53,0x4D,0x45,0x67,0x59,0x34,0x77,
0x67,0x59,0x75,0x41,0x46,0x4D,0x2F,0x55,0x0A,0x5A,0x57,0x54,0x5A,0x70,0x4D,0x75,
0x6B,0x6D,0x35,0x72,0x73,0x32,0x41,0x34,0x47,0x37,0x42,0x75,0x70,0x67,0x39,0x4F,
0x4F,0x6F,0x57,0x69,0x6B,0x5A,0x6A,0x42,0x6B,0x4D,0x51,0x73,0x77,0x43,0x51,0x59,
0x44,0x56,0x51,0x51,0x47,0x45,0x77,0x4A,0x6A,0x62,0x6A,0x45,0x52,0x4D,0x41,0x38,
0x47,0x41,0x31,0x55,0x45,0x43,0x42,0x4D,0x49,0x0A,0x63,0x32,0x68,0x6C,0x62,0x6E,
0x70,0x6F,0x5A,0x57,0x34,0x78,0x45,0x54,0x41,0x50,0x42,0x67,0x4E,0x56,0x42,0x41,
0x63,0x54,0x43,0x48,0x4E,0x6F,0x5A,0x57,0x35,0x36,0x61,0x47,0x56,0x75,0x4D,0x51,
0x38,0x77,0x44,0x51,0x59,0x44,0x56,0x51,0x51,0x4B,0x45,0x77,0x5A,0x75,0x5A,0x57,
0x78,0x6B,0x64,0x48,0x59,0x78,0x44,0x7A,0x41,0x4E,0x0A,0x42,0x67,0x4E,0x56,0x42,
0x41,0x73,0x54,0x42,0x6D,0x35,0x6C,0x62,0x47,0x52,0x30,0x64,0x6A,0x45,0x4E,0x4D,
0x41,0x73,0x47,0x41,0x31,0x55,0x45,0x41,0x78,0x4D,0x45,0x5A,0x58,0x56,0x6A,0x59,
0x59,0x49,0x4A,0x41,0x49,0x6C,0x51,0x46,0x6F,0x2B,0x48,0x71,0x35,0x30,0x76,0x4D,
0x41,0x77,0x47,0x41,0x31,0x55,0x64,0x45,0x77,0x51,0x46,0x0A,0x4D,0x41,0x4D,0x42,
0x41,0x66,0x38,0x77,0x44,0x51,0x59,0x4A,0x4B,0x6F,0x5A,0x49,0x68,0x76,0x63,0x4E,
0x41,0x51,0x45,0x46,0x42,0x51,0x41,0x44,0x67,0x67,0x45,0x42,0x41,0x47,0x4D,0x41,
0x6A,0x4E,0x47,0x31,0x68,0x39,0x46,0x71,0x6F,0x4B,0x34,0x51,0x6F,0x50,0x2F,0x4D,
0x4A,0x72,0x6E,0x5A,0x48,0x59,0x4F,0x51,0x56,0x2F,0x6E,0x57,0x0A,0x4B,0x6C,0x65,
0x6A,0x75,0x50,0x47,0x72,0x47,0x52,0x57,0x67,0x6F,0x4E,0x6B,0x36,0x57,0x4C,0x6D,
0x36,0x61,0x33,0x5A,0x62,0x71,0x71,0x6F,0x65,0x6C,0x7A,0x68,0x52,0x6F,0x4E,0x75,
0x78,0x6E,0x66,0x43,0x41,0x38,0x4A,0x2B,0x4D,0x54,0x4F,0x79,0x58,0x33,0x52,0x79,
0x38,0x52,0x38,0x6B,0x30,0x78,0x54,0x33,0x4D,0x31,0x32,0x66,0x36,0x0A,0x74,0x6A,
0x5A,0x44,0x58,0x59,0x56,0x54,0x78,0x65,0x48,0x34,0x2F,0x50,0x52,0x31,0x57,0x43,
0x6C,0x43,0x66,0x47,0x38,0x6E,0x73,0x4F,0x75,0x39,0x56,0x34,0x49,0x6D,0x51,0x45,
0x4C,0x6E,0x58,0x4A,0x6D,0x46,0x2F,0x45,0x38,0x79,0x53,0x58,0x42,0x4E,0x75,0x34,
0x52,0x4F,0x51,0x44,0x59,0x64,0x50,0x68,0x35,0x61,0x37,0x6E,0x5A,0x46,0x0A,0x6B,
0x6F,0x68,0x6A,0x66,0x39,0x65,0x70,0x68,0x2F,0x72,0x51,0x4E,0x39,0x6A,0x4D,0x4B,
0x4E,0x33,0x47,0x53,0x4E,0x56,0x32,0x6F,0x34,0x4A,0x62,0x78,0x2B,0x68,0x74,0x6F,
0x62,0x71,0x51,0x47,0x7A,0x66,0x58,0x5A,0x47,0x75,0x47,0x70,0x49,0x78,0x56,0x6D,
0x32,0x7A,0x38,0x31,0x77,0x58,0x35,0x6B,0x44,0x54,0x2B,0x54,0x70,0x32,0x59,0x0A,
0x6C,0x44,0x4E,0x6B,0x73,0x45,0x4E,0x6A,0x46,0x49,0x4F,0x4A,0x58,0x66,0x38,0x32,
0x4A,0x70,0x4C,0x64,0x67,0x73,0x4A,0x47,0x66,0x6C,0x4D,0x35,0x42,0x74,0x48,0x6D,
0x67,0x2F,0x73,0x36,0x6E,0x33,0x61,0x57,0x38,0x49,0x47,0x39,0x4E,0x48,0x77,0x77,
0x6A,0x36,0x62,0x34,0x52,0x52,0x6A,0x66,0x6E,0x53,0x46,0x73,0x59,0x6D,0x6B,0x61,
0x0A,0x39,0x56,0x71,0x76,0x36,0x33,0x4D,0x6E,0x65,0x76,0x30,0x33,0x79,0x31,0x30,
0x6B,0x66,0x53,0x57,0x56,0x4F,0x46,0x45,0x4D,0x6D,0x35,0x74,0x50,0x4E,0x55,0x51,
0x6B,0x6E,0x42,0x53,0x51,0x45,0x50,0x44,0x6E,0x67,0x79,0x74,0x48,0x32,0x52,0x6B,
0x74,0x62,0x4C,0x4B,0x50,0x4E,0x31,0x59,0x3D,0x0A,0x2D,0x2D,0x2D,0x2D,0x2D,0x45,
0x4E,0x44,0x20,0x43,0x45,0x52,0x54,0x49,0x46,0x49,0x43,0x41,0x54,0x45,0x2D,0x2D,
0x2D,0x2D,0x2D,0x0A};

BYTE softwareCAcert[]={0x2D,0x2D,0x2D,0x2D,0x2D,0x42,0x45,0x47,0x49,0x4E,0x20,0x43,0x45,0x52,0x54,0x49,
0x46,0x49,0x43,0x41,0x54,0x45,0x2D,0x2D,0x2D,0x2D,0x2D,0x0A,0x4D,0x49,0x49,0x44,
0x66,0x7A,0x43,0x43,0x41,0x6D,0x65,0x67,0x41,0x77,0x49,0x42,0x41,0x67,0x49,0x45,
0x63,0x46,0x61,0x69,0x47,0x44,0x41,0x4E,0x42,0x67,0x6B,0x71,0x68,0x6B,0x69,0x47,
0x39,0x77,0x30,0x42,0x41,0x51,0x55,0x46,0x41,0x44,0x42,0x70,0x4D,0x51,0x73,0x77,
0x43,0x51,0x59,0x44,0x56,0x51,0x51,0x47,0x45,0x77,0x4A,0x44,0x54,0x6A,0x45,0x4C,
0x4D,0x41,0x6B,0x47,0x41,0x31,0x55,0x45,0x0D,0x0A,0x43,0x42,0x4D,0x43,0x5A,0x32,
0x51,0x78,0x45,0x54,0x41,0x50,0x42,0x67,0x4E,0x56,0x42,0x41,0x63,0x54,0x43,0x48,
0x4E,0x6F,0x5A,0x57,0x35,0x36,0x61,0x47,0x56,0x75,0x4D,0x51,0x38,0x77,0x44,0x51,
0x59,0x44,0x56,0x51,0x51,0x4B,0x45,0x77,0x5A,0x75,0x5A,0x57,0x78,0x6B,0x64,0x48,
0x59,0x78,0x46,0x6A,0x41,0x55,0x42,0x67,0x4E,0x56,0x42,0x41,0x73,0x54,0x44,0x58,
0x4E,0x6C,0x59,0x33,0x56,0x79,0x0D,0x0A,0x61,0x58,0x52,0x35,0x49,0x47,0x52,0x6C,
0x63,0x48,0x51,0x78,0x45,0x54,0x41,0x50,0x42,0x67,0x4E,0x56,0x42,0x41,0x4D,0x54,
0x43,0x47,0x35,0x6C,0x62,0x47,0x52,0x30,0x64,0x6B,0x4E,0x42,0x4D,0x42,0x34,0x58,
0x44,0x54,0x45,0x7A,0x4D,0x54,0x41,0x78,0x4E,0x7A,0x41,0x79,0x4E,0x44,0x67,0x30,
0x4E,0x56,0x6F,0x58,0x44,0x54,0x49,0x7A,0x4D,0x54,0x41,0x78,0x4E,0x54,0x41,0x79,
0x4E,0x44,0x67,0x30,0x0D,0x0A,0x4E,0x56,0x6F,0x77,0x61,0x54,0x45,0x4C,0x4D,0x41,
0x6B,0x47,0x41,0x31,0x55,0x45,0x42,0x68,0x4D,0x43,0x51,0x30,0x34,0x78,0x43,0x7A,
0x41,0x4A,0x42,0x67,0x4E,0x56,0x42,0x41,0x67,0x54,0x41,0x6D,0x64,0x6B,0x4D,0x52,
0x45,0x77,0x44,0x77,0x59,0x44,0x56,0x51,0x51,0x48,0x45,0x77,0x68,0x7A,0x61,0x47,
0x56,0x75,0x65,0x6D,0x68,0x6C,0x62,0x6A,0x45,0x50,0x4D,0x41,0x30,0x47,0x41,0x31,
0x55,0x45,0x0D,0x0A,0x43,0x68,0x4D,0x47,0x62,0x6D,0x56,0x73,0x5A,0x48,0x52,0x32,
0x4D,0x52,0x59,0x77,0x46,0x41,0x59,0x44,0x56,0x51,0x51,0x4C,0x45,0x77,0x31,0x7A,
0x5A,0x57,0x4E,0x31,0x63,0x6D,0x6C,0x30,0x65,0x53,0x42,0x6B,0x5A,0x58,0x42,0x30,
0x4D,0x52,0x45,0x77,0x44,0x77,0x59,0x44,0x56,0x51,0x51,0x44,0x45,0x77,0x68,0x75,
0x5A,0x57,0x78,0x6B,0x64,0x48,0x5A,0x44,0x51,0x54,0x43,0x43,0x41,0x53,0x49,0x77,
0x0D,0x0A,0x44,0x51,0x59,0x4A,0x4B,0x6F,0x5A,0x49,0x68,0x76,0x63,0x4E,0x41,0x51,
0x45,0x42,0x42,0x51,0x41,0x44,0x67,0x67,0x45,0x50,0x41,0x44,0x43,0x43,0x41,0x51,
0x6F,0x43,0x67,0x67,0x45,0x42,0x41,0x49,0x36,0x45,0x6E,0x47,0x64,0x2F,0x56,0x46,
0x43,0x63,0x65,0x48,0x6B,0x68,0x47,0x63,0x33,0x76,0x33,0x6B,0x6F,0x63,0x44,0x6C,
0x4E,0x5A,0x62,0x75,0x66,0x53,0x46,0x46,0x32,0x30,0x6B,0x48,0x6E,0x34,0x0D,0x0A,
0x4D,0x6B,0x2B,0x56,0x72,0x4D,0x2B,0x6A,0x4D,0x2B,0x4C,0x4C,0x41,0x61,0x61,0x74,
0x47,0x72,0x59,0x41,0x42,0x78,0x4F,0x71,0x52,0x39,0x4A,0x4E,0x42,0x43,0x37,0x67,
0x34,0x37,0x61,0x5A,0x38,0x4D,0x2B,0x78,0x6C,0x77,0x79,0x2B,0x7A,0x59,0x49,0x4D,
0x5A,0x57,0x68,0x78,0x65,0x5A,0x49,0x73,0x68,0x68,0x47,0x70,0x39,0x4B,0x33,0x36,
0x57,0x50,0x63,0x7A,0x54,0x54,0x53,0x4F,0x33,0x32,0x74,0x4E,0x0D,0x0A,0x47,0x66,
0x79,0x6F,0x56,0x38,0x65,0x75,0x6E,0x45,0x79,0x56,0x78,0x51,0x51,0x4E,0x52,0x37,
0x62,0x57,0x44,0x50,0x6F,0x38,0x47,0x5A,0x6D,0x47,0x4C,0x4A,0x2F,0x46,0x42,0x4C,
0x69,0x66,0x4E,0x6E,0x56,0x4B,0x35,0x72,0x6F,0x6B,0x61,0x43,0x68,0x49,0x65,0x4E,
0x39,0x69,0x59,0x6C,0x67,0x46,0x41,0x71,0x33,0x62,0x45,0x35,0x32,0x33,0x6C,0x30,
0x4C,0x50,0x44,0x49,0x2B,0x50,0x73,0x48,0x76,0x79,0x0D,0x0A,0x38,0x63,0x59,0x78,
0x51,0x62,0x5A,0x6C,0x33,0x58,0x4A,0x52,0x74,0x72,0x4E,0x53,0x47,0x64,0x73,0x45,
0x6F,0x32,0x76,0x78,0x36,0x76,0x77,0x4A,0x77,0x50,0x37,0x43,0x68,0x49,0x79,0x37,
0x2F,0x47,0x33,0x56,0x55,0x52,0x4A,0x55,0x52,0x79,0x49,0x64,0x30,0x30,0x6A,0x41,
0x54,0x33,0x53,0x69,0x6C,0x43,0x36,0x47,0x43,0x38,0x51,0x51,0x68,0x37,0x51,0x4E,
0x35,0x45,0x2F,0x42,0x6D,0x58,0x69,0x41,0x0D,0x0A,0x6E,0x41,0x6A,0x68,0x37,0x42,
0x30,0x75,0x4D,0x78,0x69,0x42,0x78,0x62,0x55,0x51,0x56,0x4E,0x55,0x56,0x6D,0x39,
0x6C,0x46,0x4D,0x52,0x4F,0x5A,0x6E,0x6E,0x76,0x32,0x4E,0x52,0x39,0x4B,0x71,0x46,
0x43,0x6F,0x74,0x79,0x70,0x51,0x33,0x4A,0x48,0x39,0x38,0x54,0x79,0x38,0x4F,0x67,
0x55,0x6E,0x59,0x59,0x61,0x73,0x59,0x33,0x43,0x4E,0x36,0x76,0x64,0x78,0x2F,0x6A,
0x2B,0x68,0x46,0x41,0x6B,0x43,0x0D,0x0A,0x41,0x77,0x45,0x41,0x41,0x61,0x4D,0x76,
0x4D,0x43,0x30,0x77,0x44,0x41,0x59,0x44,0x56,0x52,0x30,0x54,0x42,0x41,0x55,0x77,
0x41,0x77,0x45,0x42,0x2F,0x7A,0x41,0x64,0x42,0x67,0x4E,0x56,0x48,0x51,0x34,0x45,
0x46,0x67,0x51,0x55,0x62,0x63,0x75,0x54,0x62,0x79,0x66,0x57,0x61,0x54,0x61,0x65,
0x72,0x39,0x5A,0x79,0x31,0x37,0x58,0x67,0x35,0x50,0x4B,0x36,0x48,0x5A,0x38,0x77,
0x44,0x51,0x59,0x4A,0x0D,0x0A,0x4B,0x6F,0x5A,0x49,0x68,0x76,0x63,0x4E,0x41,0x51,
0x45,0x46,0x42,0x51,0x41,0x44,0x67,0x67,0x45,0x42,0x41,0x46,0x70,0x62,0x6C,0x4F,
0x77,0x2F,0x45,0x6E,0x79,0x59,0x75,0x39,0x34,0x61,0x45,0x77,0x75,0x62,0x39,0x64,
0x74,0x72,0x62,0x2B,0x36,0x38,0x75,0x79,0x79,0x61,0x64,0x46,0x72,0x70,0x39,0x6A,
0x44,0x72,0x66,0x53,0x4D,0x4D,0x74,0x4B,0x7A,0x31,0x52,0x56,0x4E,0x68,0x4F,0x70,
0x76,0x78,0x0D,0x0A,0x30,0x4E,0x52,0x55,0x50,0x69,0x6F,0x69,0x6B,0x63,0x6A,0x44,
0x38,0x4A,0x30,0x31,0x47,0x51,0x49,0x4C,0x6D,0x78,0x2F,0x79,0x4A,0x57,0x42,0x6C,
0x44,0x44,0x74,0x72,0x6F,0x44,0x52,0x57,0x4D,0x51,0x79,0x62,0x46,0x73,0x4D,0x49,
0x52,0x45,0x6C,0x6D,0x67,0x75,0x42,0x73,0x54,0x36,0x59,0x55,0x78,0x53,0x35,0x4D,
0x67,0x45,0x52,0x78,0x42,0x39,0x64,0x33,0x75,0x61,0x62,0x54,0x54,0x54,0x54,0x71,
0x0D,0x0A,0x4D,0x34,0x37,0x79,0x79,0x69,0x69,0x4E,0x77,0x4C,0x4E,0x78,0x32,0x65,
0x38,0x58,0x51,0x43,0x6E,0x76,0x4F,0x6D,0x61,0x73,0x6A,0x47,0x53,0x78,0x6F,0x70,
0x6E,0x64,0x72,0x45,0x79,0x33,0x57,0x30,0x6A,0x62,0x75,0x4B,0x43,0x69,0x6F,0x32,
0x66,0x67,0x44,0x31,0x37,0x51,0x59,0x5A,0x45,0x6D,0x4C,0x67,0x37,0x50,0x69,0x59,
0x53,0x71,0x4C,0x45,0x75,0x4E,0x46,0x73,0x36,0x4C,0x6E,0x4C,0x42,0x2B,0x0D,0x0A,
0x54,0x44,0x6A,0x49,0x55,0x55,0x33,0x33,0x38,0x55,0x35,0x58,0x6E,0x63,0x4C,0x46,
0x65,0x4E,0x69,0x6A,0x47,0x78,0x35,0x70,0x66,0x72,0x4C,0x52,0x33,0x34,0x52,0x61,
0x7A,0x34,0x57,0x65,0x61,0x64,0x31,0x65,0x37,0x69,0x45,0x4F,0x33,0x6B,0x63,0x55,
0x55,0x7A,0x43,0x57,0x2B,0x7A,0x4A,0x30,0x6D,0x33,0x66,0x2B,0x70,0x5A,0x39,0x6A,
0x53,0x6B,0x57,0x33,0x62,0x61,0x67,0x63,0x68,0x65,0x6B,0x45,0x0D,0x0A,0x71,0x79,
0x78,0x2B,0x6F,0x32,0x47,0x58,0x6E,0x6E,0x53,0x75,0x62,0x73,0x73,0x53,0x6B,0x4A,
0x6A,0x52,0x78,0x4A,0x6D,0x42,0x78,0x39,0x72,0x54,0x78,0x30,0x62,0x4D,0x4D,0x2F,
0x6B,0x7A,0x67,0x4D,0x35,0x57,0x53,0x77,0x61,0x2F,0x35,0x71,0x4A,0x79,0x4B,0x57,
0x31,0x2F,0x4C,0x69,0x2F,0x50,0x74,0x59,0x34,0x3D,0x0D,0x0A,0x0A,0x2D,0x2D,0x2D,
0x2D,0x2D,0x45,0x4E,0x44,0x20,0x43,0x45,0x52,0x54,0x49,0x46,0x49,0x43,0x41,0x54,
0x45,0x2D,0x2D,0x2D,0x2D,0x2D};

BYTE privateCAcert[]={0x2D,0x2D,0x2D,0x2D,0x2D,0x42,0x45,0x47,0x49,0x4E,0x20,0x43,0x45,0x52,0x54,0x49
,0x46,0x49,0x43,0x41,0x54,0x45,0x2D,0x2D,0x2D,0x2D,0x2D,0x0A,0x4D,0x49,0x49,0x45
,0x68,0x6A,0x43,0x43,0x41,0x32,0x36,0x67,0x41,0x77,0x49,0x42,0x41,0x67,0x49,0x4A
,0x41,0x4E,0x4F,0x76,0x54,0x78,0x67,0x76,0x32,0x56,0x69,0x41,0x4D,0x41,0x30,0x47
,0x43,0x53,0x71,0x47,0x53,0x49,0x62,0x33,0x44,0x51,0x45,0x42,0x42,0x51,0x55,0x41
,0x4D,0x49,0x47,0x49,0x4D,0x51,0x73,0x77,0x43,0x51,0x59,0x44,0x0A,0x56,0x51,0x51
,0x47,0x45,0x77,0x4A,0x6A,0x62,0x6A,0x45,0x53,0x4D,0x42,0x41,0x47,0x41,0x31,0x55
,0x45,0x43,0x42,0x4D,0x4A,0x5A,0x33,0x56,0x68,0x62,0x6D,0x64,0x6B,0x62,0x32,0x35
,0x6E,0x4D,0x52,0x45,0x77,0x44,0x77,0x59,0x44,0x56,0x51,0x51,0x48,0x45,0x77,0x68
,0x7A,0x61,0x47,0x56,0x75,0x65,0x6D,0x68,0x6C,0x62,0x6A,0x45,0x50,0x0A,0x4D,0x41
,0x30,0x47,0x41,0x31,0x55,0x45,0x43,0x68,0x4D,0x47,0x62,0x6D,0x56,0x73,0x5A,0x48
,0x52,0x32,0x4D,0x51,0x38,0x77,0x44,0x51,0x59,0x44,0x56,0x51,0x51,0x4C,0x45,0x77
,0x5A,0x75,0x5A,0x57,0x78,0x6B,0x64,0x48,0x59,0x78,0x45,0x7A,0x41,0x52,0x42,0x67
,0x4E,0x56,0x42,0x41,0x4D,0x54,0x43,0x6E,0x68,0x70,0x59,0x57,0x39,0x33,0x0A,0x5A
,0x57,0x35,0x30,0x59,0x57,0x38,0x78,0x47,0x7A,0x41,0x5A,0x42,0x67,0x6B,0x71,0x68
,0x6B,0x69,0x47,0x39,0x77,0x30,0x42,0x43,0x51,0x45,0x57,0x44,0x48,0x68,0x70,0x59
,0x57,0x39,0x41,0x4D,0x54,0x59,0x7A,0x4C,0x6D,0x4E,0x76,0x62,0x54,0x41,0x65,0x46
,0x77,0x30,0x78,0x4D,0x6A,0x45,0x77,0x4D,0x7A,0x41,0x77,0x4F,0x54,0x41,0x34,0x0A
,0x4D,0x44,0x46,0x61,0x46,0x77,0x30,0x7A,0x4D,0x6A,0x41,0x33,0x4D,0x54,0x63,0x77
,0x4F,0x54,0x41,0x34,0x4D,0x44,0x46,0x61,0x4D,0x49,0x47,0x49,0x4D,0x51,0x73,0x77
,0x43,0x51,0x59,0x44,0x56,0x51,0x51,0x47,0x45,0x77,0x4A,0x6A,0x62,0x6A,0x45,0x53
,0x4D,0x42,0x41,0x47,0x41,0x31,0x55,0x45,0x43,0x42,0x4D,0x4A,0x5A,0x33,0x56,0x68
,0x0A,0x62,0x6D,0x64,0x6B,0x62,0x32,0x35,0x6E,0x4D,0x52,0x45,0x77,0x44,0x77,0x59
,0x44,0x56,0x51,0x51,0x48,0x45,0x77,0x68,0x7A,0x61,0x47,0x56,0x75,0x65,0x6D,0x68
,0x6C,0x62,0x6A,0x45,0x50,0x4D,0x41,0x30,0x47,0x41,0x31,0x55,0x45,0x43,0x68,0x4D
,0x47,0x62,0x6D,0x56,0x73,0x5A,0x48,0x52,0x32,0x4D,0x51,0x38,0x77,0x44,0x51,0x59
,0x44,0x0A,0x56,0x51,0x51,0x4C,0x45,0x77,0x5A,0x75,0x5A,0x57,0x78,0x6B,0x64,0x48
,0x59,0x78,0x45,0x7A,0x41,0x52,0x42,0x67,0x4E,0x56,0x42,0x41,0x4D,0x54,0x43,0x6E
,0x68,0x70,0x59,0x57,0x39,0x33,0x5A,0x57,0x35,0x30,0x59,0x57,0x38,0x78,0x47,0x7A
,0x41,0x5A,0x42,0x67,0x6B,0x71,0x68,0x6B,0x69,0x47,0x39,0x77,0x30,0x42,0x43,0x51
,0x45,0x57,0x0A,0x44,0x48,0x68,0x70,0x59,0x57,0x39,0x41,0x4D,0x54,0x59,0x7A,0x4C
,0x6D,0x4E,0x76,0x62,0x54,0x43,0x43,0x41,0x53,0x49,0x77,0x44,0x51,0x59,0x4A,0x4B
,0x6F,0x5A,0x49,0x68,0x76,0x63,0x4E,0x41,0x51,0x45,0x42,0x42,0x51,0x41,0x44,0x67
,0x67,0x45,0x50,0x41,0x44,0x43,0x43,0x41,0x51,0x6F,0x43,0x67,0x67,0x45,0x42,0x41
,0x4C,0x32,0x63,0x0A,0x48,0x55,0x32,0x61,0x33,0x5A,0x32,0x32,0x65,0x33,0x77,0x49
,0x51,0x4A,0x47,0x48,0x52,0x70,0x6E,0x56,0x47,0x47,0x6C,0x62,0x4F,0x70,0x77,0x74
,0x57,0x59,0x43,0x51,0x75,0x59,0x35,0x30,0x49,0x4C,0x45,0x5A,0x53,0x42,0x2F,0x55
,0x54,0x55,0x6C,0x2F,0x56,0x64,0x69,0x47,0x55,0x7A,0x48,0x5A,0x63,0x54,0x58,0x41
,0x37,0x72,0x5A,0x68,0x0A,0x6C,0x33,0x61,0x34,0x67,0x30,0x53,0x44,0x2F,0x48,0x50
,0x62,0x6D,0x70,0x47,0x61,0x49,0x30,0x53,0x4A,0x5A,0x44,0x46,0x45,0x71,0x68,0x41
,0x63,0x5A,0x4D,0x52,0x46,0x70,0x51,0x63,0x53,0x43,0x71,0x66,0x38,0x59,0x51,0x39
,0x51,0x43,0x46,0x6F,0x41,0x4C,0x44,0x4F,0x71,0x30,0x57,0x62,0x4A,0x53,0x39,0x38
,0x51,0x44,0x62,0x64,0x48,0x0A,0x72,0x67,0x7A,0x6D,0x77,0x6C,0x70,0x75,0x63,0x53
,0x69,0x47,0x37,0x6F,0x56,0x63,0x44,0x6E,0x77,0x35,0x54,0x47,0x56,0x52,0x75,0x67
,0x48,0x4A,0x59,0x51,0x63,0x31,0x4A,0x4E,0x6A,0x68,0x56,0x6C,0x79,0x32,0x46,0x52
,0x71,0x70,0x62,0x2B,0x4A,0x69,0x32,0x32,0x42,0x41,0x6A,0x6C,0x49,0x4C,0x7A,0x32
,0x44,0x62,0x32,0x48,0x6D,0x55,0x0A,0x71,0x30,0x6C,0x6E,0x2B,0x6A,0x72,0x4D,0x6C
,0x4A,0x58,0x78,0x46,0x55,0x53,0x4A,0x59,0x45,0x67,0x58,0x37,0x6D,0x2F,0x7A,0x62
,0x54,0x49,0x64,0x50,0x35,0x38,0x39,0x41,0x6A,0x39,0x35,0x46,0x32,0x6C,0x45,0x75
,0x79,0x70,0x2F,0x65,0x7A,0x62,0x34,0x49,0x34,0x73,0x55,0x78,0x76,0x49,0x5A,0x71
,0x63,0x78,0x36,0x70,0x38,0x74,0x6C,0x0A,0x35,0x58,0x51,0x6A,0x47,0x2F,0x4B,0x75
,0x4B,0x6A,0x54,0x69,0x39,0x58,0x46,0x4A,0x50,0x75,0x69,0x73,0x30,0x37,0x72,0x33
,0x43,0x64,0x42,0x42,0x6B,0x64,0x75,0x74,0x52,0x6B,0x45,0x68,0x32,0x69,0x5A,0x37
,0x72,0x64,0x4B,0x38,0x65,0x4A,0x56,0x71,0x77,0x67,0x66,0x4C,0x2F,0x70,0x45,0x33
,0x55,0x66,0x69,0x68,0x4F,0x66,0x7A,0x34,0x0A,0x64,0x71,0x63,0x4F,0x2B,0x67,0x32
,0x79,0x63,0x6E,0x70,0x43,0x67,0x5A,0x49,0x41,0x44,0x73,0x63,0x43,0x41,0x77,0x45
,0x41,0x41,0x61,0x4F,0x42,0x38,0x44,0x43,0x42,0x37,0x54,0x41,0x64,0x42,0x67,0x4E
,0x56,0x48,0x51,0x34,0x45,0x46,0x67,0x51,0x55,0x6B,0x65,0x42,0x57,0x37,0x64,0x4F
,0x34,0x4A,0x50,0x62,0x49,0x65,0x76,0x44,0x51,0x0A,0x70,0x39,0x51,0x6C,0x73,0x64
,0x68,0x61,0x6B,0x61,0x6B,0x77,0x67,0x62,0x30,0x47,0x41,0x31,0x55,0x64,0x49,0x77
,0x53,0x42,0x74,0x54,0x43,0x42,0x73,0x6F,0x41,0x55,0x6B,0x65,0x42,0x57,0x37,0x64
,0x4F,0x34,0x4A,0x50,0x62,0x49,0x65,0x76,0x44,0x51,0x70,0x39,0x51,0x6C,0x73,0x64
,0x68,0x61,0x6B,0x61,0x6D,0x68,0x67,0x59,0x36,0x6B,0x0A,0x67,0x59,0x73,0x77,0x67
,0x59,0x67,0x78,0x43,0x7A,0x41,0x4A,0x42,0x67,0x4E,0x56,0x42,0x41,0x59,0x54,0x41
,0x6D,0x4E,0x75,0x4D,0x52,0x49,0x77,0x45,0x41,0x59,0x44,0x56,0x51,0x51,0x49,0x45
,0x77,0x6C,0x6E,0x64,0x57,0x46,0x75,0x5A,0x32,0x52,0x76,0x62,0x6D,0x63,0x78,0x45
,0x54,0x41,0x50,0x42,0x67,0x4E,0x56,0x42,0x41,0x63,0x54,0x0A,0x43,0x48,0x4E,0x6F
,0x5A,0x57,0x35,0x36,0x61,0x47,0x56,0x75,0x4D,0x51,0x38,0x77,0x44,0x51,0x59,0x44
,0x56,0x51,0x51,0x4B,0x45,0x77,0x5A,0x75,0x5A,0x57,0x78,0x6B,0x64,0x48,0x59,0x78
,0x44,0x7A,0x41,0x4E,0x42,0x67,0x4E,0x56,0x42,0x41,0x73,0x54,0x42,0x6D,0x35,0x6C
,0x62,0x47,0x52,0x30,0x64,0x6A,0x45,0x54,0x4D,0x42,0x45,0x47,0x0A,0x41,0x31,0x55
,0x45,0x41,0x78,0x4D,0x4B,0x65,0x47,0x6C,0x68,0x62,0x33,0x64,0x6C,0x62,0x6E,0x52
,0x68,0x62,0x7A,0x45,0x62,0x4D,0x42,0x6B,0x47,0x43,0x53,0x71,0x47,0x53,0x49,0x62
,0x33,0x44,0x51,0x45,0x4A,0x41,0x52,0x59,0x4D,0x65,0x47,0x6C,0x68,0x62,0x30,0x41
,0x78,0x4E,0x6A,0x4D,0x75,0x59,0x32,0x39,0x74,0x67,0x67,0x6B,0x41,0x0A,0x30,0x36
,0x39,0x50,0x47,0x43,0x2F,0x5A,0x57,0x49,0x41,0x77,0x44,0x41,0x59,0x44,0x56,0x52
,0x30,0x54,0x42,0x41,0x55,0x77,0x41,0x77,0x45,0x42,0x2F,0x7A,0x41,0x4E,0x42,0x67
,0x6B,0x71,0x68,0x6B,0x69,0x47,0x39,0x77,0x30,0x42,0x41,0x51,0x55,0x46,0x41,0x41
,0x4F,0x43,0x41,0x51,0x45,0x41,0x69,0x37,0x30,0x35,0x5A,0x38,0x66,0x45,0x0A,0x45
,0x44,0x48,0x61,0x67,0x70,0x68,0x39,0x33,0x6B,0x38,0x46,0x53,0x75,0x37,0x6E,0x71
,0x36,0x6B,0x2F,0x2F,0x55,0x4E,0x6C,0x73,0x33,0x6B,0x55,0x61,0x47,0x69,0x6F,0x66
,0x75,0x50,0x4C,0x75,0x6B,0x4B,0x6B,0x62,0x42,0x39,0x42,0x36,0x4C,0x55,0x73,0x4B
,0x50,0x37,0x6E,0x38,0x54,0x6B,0x2B,0x46,0x64,0x4E,0x76,0x53,0x4F,0x2F,0x36,0x0A
,0x61,0x79,0x43,0x77,0x6F,0x44,0x2B,0x32,0x2F,0x46,0x73,0x47,0x37,0x4C,0x31,0x37
,0x4F,0x74,0x53,0x34,0x42,0x4D,0x33,0x47,0x6F,0x57,0x4A,0x4A,0x52,0x35,0x66,0x71
,0x49,0x2B,0x41,0x38,0x50,0x7A,0x4E,0x43,0x31,0x48,0x72,0x65,0x34,0x4F,0x44,0x78
,0x52,0x73,0x66,0x62,0x71,0x66,0x55,0x79,0x4D,0x35,0x6D,0x74,0x4D,0x75,0x4C,0x44
,0x0A,0x6C,0x72,0x75,0x31,0x79,0x69,0x36,0x59,0x33,0x49,0x31,0x6B,0x5A,0x58,0x70
,0x52,0x7A,0x33,0x75,0x53,0x39,0x74,0x64,0x33,0x55,0x31,0x46,0x6A,0x70,0x45,0x34
,0x35,0x2F,0x51,0x6F,0x6D,0x47,0x48,0x4B,0x42,0x34,0x54,0x49,0x4F,0x72,0x61,0x49
,0x65,0x6B,0x69,0x46,0x55,0x35,0x4A,0x46,0x50,0x53,0x78,0x64,0x52,0x75,0x5A,0x57
,0x6A,0x0A,0x77,0x6F,0x37,0x34,0x37,0x70,0x50,0x53,0x65,0x78,0x62,0x2F,0x63,0x4A
,0x73,0x6E,0x6A,0x71,0x43,0x6C,0x49,0x2F,0x34,0x55,0x64,0x59,0x74,0x6E,0x75,0x6A
,0x4C,0x39,0x6B,0x32,0x63,0x6F,0x75,0x76,0x55,0x36,0x43,0x78,0x6E,0x31,0x4E,0x35
,0x78,0x74,0x34,0x45,0x57,0x44,0x51,0x31,0x39,0x65,0x48,0x4C,0x2B,0x55,0x6A,0x5A
,0x49,0x54,0x0A,0x32,0x79,0x42,0x31,0x5A,0x75,0x44,0x65,0x62,0x69,0x58,0x2B,0x61
,0x7A,0x31,0x4F,0x45,0x31,0x6A,0x45,0x77,0x73,0x44,0x2B,0x44,0x38,0x72,0x4D,0x77
,0x43,0x65,0x6D,0x4B,0x34,0x73,0x30,0x66,0x43,0x43,0x64,0x2F,0x2F,0x71,0x2F,0x47
,0x38,0x67,0x76,0x6D,0x43,0x66,0x78,0x30,0x66,0x4F,0x66,0x37,0x4B,0x74,0x74,0x69
,0x6D,0x64,0x2F,0x0A,0x45,0x69,0x49,0x45,0x2B,0x62,0x4D,0x51,0x36,0x52,0x6B,0x77
,0x70,0x51,0x3D,0x3D,0x0A,0x2D,0x2D,0x2D,0x2D,0x2D,0x45,0x4E,0x44,0x20,0x43,0x45
,0x52,0x54,0x49,0x46,0x49,0x43,0x41,0x54,0x45,0x2D,0x2D,0x2D,0x2D,0x2D,0x0A};


void
LoadBlob_SYMMETRIC_KEY(UINT64 *offset, BYTE *blob, TCPA_SYMMETRIC_KEY *key)
{
	LoadBlob_UINT32(offset, key->algId, blob);
	LoadBlob_UINT16(offset, key->encScheme, blob);
	LoadBlob_UINT16(offset, key->size, blob);

	if (key->size > 0) {
		LoadBlob(offset, key->size, blob, key->data);
	} else {
		key->data = NULL;
	}
}

TSS_RESULT
UnloadBlob_SYMMETRIC_KEY(UINT64 *offset, BYTE *blob, TCPA_SYMMETRIC_KEY *key)
{
	if (!key) {
		UINT16 size;

		UnloadBlob_UINT32(offset, NULL, blob);
		UnloadBlob_UINT16(offset, NULL, blob);
		UnloadBlob_UINT16(offset, &size, blob);

		if (size > 0)
			UnloadBlob(offset, size, blob, NULL);

		return TSS_SUCCESS;
	}

	UnloadBlob_UINT32(offset, &key->algId, blob);
	UnloadBlob_UINT16(offset, &key->encScheme, blob);
	UnloadBlob_UINT16(offset, &key->size, blob);

	if (key->size > 0) {
		key->data = (BYTE *)malloc(key->size);
		if (key->data == NULL) {
			LogError("malloc of %hu bytes failed.", key->size);
			key->size = 0;
			return TCSERR(TSS_E_OUTOFMEMORY);
		}
		UnloadBlob(offset, key->size, blob, key->data);
	} else {
		key->data = NULL;
	}

	return TSS_SUCCESS;
}

#define CERT_FILE_FORM "%8d\t%8d\t"
void
get_credential(UINT32 type, UINT32 *size, BYTE **cred)
{
	int rc, fd;
	char *path = NULL;
	void *file = NULL;
	struct stat stat_buf;
	size_t file_size;

	FILE *fp = NULL;
	UINT32 index;
	UINT32 certLen;

	switch (type) {
		case TSS_TCS_CREDENTIAL_PLATFORMCERT:
			path = tcsd_options.platform_cred;
			break;
		case TSS_TCS_CREDENTIAL_TPM_CC:
			path = tcsd_options.conformance_cred;
			break;
		case TSS_TCS_CREDENTIAL_EKCERT:
			path = tcsd_options.endorsement_cred;
			break;
		default: 
			path = TCSD_CREDENTIAL_FILE;
			break;
	}

	if (path == NULL)
		goto done;

	switch (type) {
		case TSS_TCS_CREDENTIAL_PLATFORMCERT:
		case TSS_TCS_CREDENTIAL_TPM_CC:
		case TSS_TCS_CREDENTIAL_EKCERT:
			if ((fd = open(path, O_RDONLY)) < 0) {
				LogError("open(%s): %s", path, strerror(errno));
				goto done;
			}
	
			if ((rc = fstat(fd, &stat_buf)) == -1) {
				LogError("Error stating credential: %s: %s", path, strerror(errno));
				goto done;
			}

			file_size = (size_t)stat_buf.st_size;

			LogDebugFn("%s, (%zd bytes)", path, file_size);

			file = mmap(0, file_size, PROT_READ, MAP_PRIVATE, fd, 0);
			if (file == MAP_FAILED) {
				LogError("Error reading credential: %s: %s", path, strerror(errno));
				close(fd);
				goto done;
			}
			close(fd);

			if ((*cred = malloc(file_size)) == NULL) {
				LogError("malloc of %zd bytes failed.", file_size);
				munmap(file, file_size);
				goto done;
			}

			memcpy(*cred, file, file_size);
			*size = file_size;
			munmap(file, file_size);

			return;
		case TSSI_CREDENTIAL_INDEX_EUCACert:
			file_size= sizeof(euCAcert);
			if ((*cred = malloc(file_size)) == NULL) {
				LogError("malloc of %zd bytes failed.", file_size);
				goto done;
			}
			*size = file_size;
			memcpy(*cred, euCAcert, *size);
			return;
		case TSSI_CREDENTIAL_INDEX_SoftCACert:
			file_size= sizeof(softwareCAcert);
			if ((*cred = malloc(file_size)) == NULL) {
				LogError("malloc of %zd bytes failed.", file_size);
				goto done;
			}
			*size = file_size;
			memcpy(*cred, softwareCAcert, *size);
			return;
		case TSSI_CREDENTIAL_INDEX_PrivacyCACert:
			file_size= sizeof(privateCAcert);
			if ((*cred = malloc(file_size)) == NULL) {
				LogError("malloc of %zd bytes failed.", file_size);
				goto done;
			}
			*size = file_size;
			memcpy(*cred, privateCAcert, *size);
			return;
		default:
			*size = 0; 
			fp = fopen(path, "r");
			if (!fp) {
				LogError("Open %s failed.", path);
				goto done;
			}
			while(fscanf(fp, CERT_FILE_FORM, &index, &certLen) >= 0) {
				if (index == type) {
					*size = certLen;
					if ((*cred = malloc(*size)) == NULL) {
						LogError("malloc of %zd bytes failed.", *size);
						goto done;
					}
					for(;certLen>0;certLen--){
						(*cred)[(*size)-certLen] = fgetc(fp);
					}
					fclose(fp);
					return;
				}else {
					for(;certLen>0;certLen--) {
						fgetc(fp);
					}
					fgetc(fp); // "\n"
				}
			}
			fclose(fp);
			return;
	}
done:
	*cred = NULL;
	*size = 0;
}


UINT32 set_credential(UINT32 type, UINT32 size, BYTE *cred)
{
	char *path = NULL;
	FILE *fp = NULL;
	UINT32 index;
	UINT32 certLen;

	UINT32 fileSize;
	BYTE * fileContents;

	switch (type) {
		case TSS_TCS_CREDENTIAL_PLATFORMCERT:
		case TSS_TCS_CREDENTIAL_TPM_CC:
		case TSS_TCS_CREDENTIAL_EKCERT:
			LogError("Bad index.");
			return 0x01;
		default:
			path = TCSD_CREDENTIAL_FILE;
	}

	// copy credentials except the target to fileContents
	fp = fopen(path, "r");
	if (!fp) {
		fileSize = 0;
	} else {
		fseek(fp, 0, SEEK_END);
		fileSize = ftell(fp);
		fseek(fp, 0, SEEK_SET);
		fileContents = (BYTE*)malloc(fileSize * sizeof(BYTE));
		if ( !fileContents ) {
			LogError("malloc failed.");
			fclose(fp);
			return 0x03;
		}
		fileSize = 0;
		while(fscanf(fp, CERT_FILE_FORM, &index, &certLen) >= 0) {
			if (index == type) {
				certLen++;
				for (; certLen>0; certLen--) {
					fgetc(fp);
				}
			} else {
				UINT32ToArray(index, &(fileContents[fileSize]));
				fileSize += sizeof(UINT32);
				UINT32ToArray(certLen, &(fileContents[fileSize]));
				fileSize += sizeof(UINT32);
				certLen++;
				for (; certLen>0; certLen--) {
					fileContents[fileSize] = fgetc(fp);
					fileSize++;
				}
			}
		}
		fclose(fp);
	}

	// copy credentials from fileContents
	fp = fopen(path, "w");
	if (!fp) {
		LogError("Open fp failed.");
		free(fileContents);
		return 0x04;
	}
	UINT32 pos = 0;
	while ( pos < fileSize ) {
		index = Decode_UINT32( &(fileContents[pos]) );
		certLen = Decode_UINT32( &(fileContents[pos+4]) );
		fprintf(fp, CERT_FILE_FORM, index, certLen);
		pos += 8;
		certLen++;
		for (; certLen>0; certLen--) {
			fputc(fileContents[pos], fp);
			pos++;
		}
	}
	
	// insert the credential
	fprintf(fp, CERT_FILE_FORM, type, size);
	for(certLen=0; certLen<size; certLen++) {
		fputc(cred[certLen], fp);
	}
	fputc('\n', fp);
	fclose(fp);
	return 0x00;
}
